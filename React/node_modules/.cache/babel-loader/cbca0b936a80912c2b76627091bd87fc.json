{"ast":null,"code":"\"use strict\"; // Copyright (c) Microsoft Corporation. All rights reserved.\n// Licensed under the MIT License. See License.txt in the project root for license information.\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : new P(function (resolve) {\n        resolve(result.value);\n      }).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst ms_rest_js_1 = require(\"@azure/ms-rest-js\");\n\nconst ms_rest_azure_env_1 = require(\"@azure/ms-rest-azure-env\");\n\nconst adal_node_1 = require(\"adal-node\");\n\nclass TokenCredentialsBase {\n  constructor(clientId, domain, tokenAudience, environment = ms_rest_azure_env_1.Environment.AzureCloud, tokenCache = new adal_node_1.MemoryCache()) {\n    this.clientId = clientId;\n    this.domain = domain;\n    this.tokenAudience = tokenAudience;\n    this.environment = environment;\n    this.tokenCache = tokenCache;\n\n    if (!clientId || typeof clientId.valueOf() !== \"string\") {\n      throw new Error(\"clientId must be a non empty string.\");\n    }\n\n    if (!domain || typeof domain.valueOf() !== \"string\") {\n      throw new Error(\"domain must be a non empty string.\");\n    }\n\n    if (this.tokenAudience === \"graph\" && this.domain.toLowerCase() === \"common\") {\n      throw new Error(`${\"If the tokenAudience is specified as \\\"graph\\\" then \\\"domain\\\" cannot be defaulted to \\\"commmon\\\" tenant.\\\n        It must be the actual tenant (preferrably a string in a guid format).\"}`);\n    }\n\n    const authorityUrl = this.environment.activeDirectoryEndpointUrl + this.domain;\n    this.authContext = new adal_node_1.AuthenticationContext(authorityUrl, this.environment.validateAuthority, this.tokenCache);\n  }\n\n  getActiveDirectoryResourceId() {\n    let resource = this.environment.activeDirectoryResourceId;\n\n    if (this.tokenAudience) {\n      resource = this.tokenAudience;\n\n      if (this.tokenAudience.toLowerCase() === \"graph\") {\n        resource = this.environment.activeDirectoryGraphResourceId;\n      } else if (this.tokenAudience.toLowerCase() === \"batch\") {\n        resource = this.environment.batchResourceId;\n      }\n    }\n\n    return resource;\n  }\n\n  getTokenFromCache(username) {\n    const self = this;\n    const resource = this.getActiveDirectoryResourceId();\n    return new Promise((resolve, reject) => {\n      self.authContext.acquireToken(resource, username, self.clientId, (error, tokenResponse) => {\n        if (error) {\n          return reject(error);\n        }\n\n        if (tokenResponse.error || tokenResponse.errorDescription) {\n          return reject(tokenResponse);\n        }\n\n        return resolve(tokenResponse);\n      });\n    });\n  }\n  /**\n   * Signs a request with the Authentication header.\n   *\n   * @param {webResource} The WebResource to be signed.\n   * @param {function(error)}  callback  The callback function.\n   * @return {undefined}\n   */\n\n\n  signRequest(webResource) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const tokenResponse = yield this.getToken();\n      webResource.headers.set(ms_rest_js_1.Constants.HeaderConstants.AUTHORIZATION, `${tokenResponse.tokenType} ${tokenResponse.accessToken}`);\n      return Promise.resolve(webResource);\n    });\n  }\n\n}\n\nexports.TokenCredentialsBase = TokenCredentialsBase;","map":{"version":3,"sources":["../../../lib/credentials/tokenCredentialsBase.ts"],"names":[],"mappings":"cAAA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAEA,MAAA,YAAA,GAAA,OAAA,CAAA,mBAAA,CAAA;;AACA,MAAA,mBAAA,GAAA,OAAA,CAAA,0BAAA,CAAA;;AAGA,MAAA,WAAA,GAAA,OAAA,CAAA,WAAA,CAAA;;AAEA,MAAsB,oBAAtB,CAA0C;AAGxC,EAAA,WAAA,CACkB,QADlB,EAES,MAFT,EAGkB,aAHlB,EAIkB,WAAA,GAA2B,mBAAA,CAAA,WAAA,CAAY,UAJzD,EAKS,UAAA,GAAyB,IAAI,WAAA,CAAA,WAAJ,EALlC,EAKmD;AAJjC,SAAA,QAAA,GAAA,QAAA;AACT,SAAA,MAAA,GAAA,MAAA;AACS,SAAA,aAAA,GAAA,aAAA;AACA,SAAA,WAAA,GAAA,WAAA;AACT,SAAA,UAAA,GAAA,UAAA;;AAEP,QAAI,CAAC,QAAD,IAAa,OAAO,QAAQ,CAAC,OAAT,EAAP,KAA8B,QAA/C,EAAyD;AACvD,YAAM,IAAI,KAAJ,CAAU,sCAAV,CAAN;AACD;;AAED,QAAI,CAAC,MAAD,IAAW,OAAO,MAAM,CAAC,OAAP,EAAP,KAA4B,QAA3C,EAAqD;AACnD,YAAM,IAAI,KAAJ,CAAU,oCAAV,CAAN;AACD;;AAED,QAAI,KAAK,aAAL,KAAuB,OAAvB,IAAkC,KAAK,MAAL,CAAY,WAAZ,OAA8B,QAApE,EAA8E;AAC5E,YAAM,IAAI,KAAJ,CAAU,GAAG;8EACqD,EADlE,CAAN;AAED;;AAED,UAAM,YAAY,GAAG,KAAK,WAAL,CAAiB,0BAAjB,GAA8C,KAAK,MAAxE;AACA,SAAK,WAAL,GAAmB,IAAI,WAAA,CAAA,qBAAJ,CAA0B,YAA1B,EAAwC,KAAK,WAAL,CAAiB,iBAAzD,EAA4E,KAAK,UAAjF,CAAnB;AACD;;AAES,EAAA,4BAA4B,GAAA;AACpC,QAAI,QAAQ,GAAG,KAAK,WAAL,CAAiB,yBAAhC;;AACA,QAAI,KAAK,aAAT,EAAwB;AACtB,MAAA,QAAQ,GAAG,KAAK,aAAhB;;AACA,UAAI,KAAK,aAAL,CAAmB,WAAnB,OAAqC,OAAzC,EAAkD;AAChD,QAAA,QAAQ,GAAG,KAAK,WAAL,CAAiB,8BAA5B;AACD,OAFD,MAEO,IAAI,KAAK,aAAL,CAAmB,WAAnB,OAAqC,OAAzC,EAAkD;AACvD,QAAA,QAAQ,GAAG,KAAK,WAAL,CAAiB,eAA5B;AACD;AACF;;AACD,WAAO,QAAP;AACD;;AAES,EAAA,iBAAiB,CAAC,QAAD,EAAkB;AAC3C,UAAM,IAAI,GAAG,IAAb;AACA,UAAM,QAAQ,GAAG,KAAK,4BAAL,EAAjB;AAEA,WAAO,IAAI,OAAJ,CAA2B,CAAC,OAAD,EAAU,MAAV,KAAoB;AACpD,MAAA,IAAI,CAAC,WAAL,CAAiB,YAAjB,CAA8B,QAA9B,EAAwC,QAAxC,EAAmD,IAAI,CAAC,QAAxD,EAAkE,CAAC,KAAD,EAAe,aAAf,KAA+D;AAC/H,YAAI,KAAJ,EAAW;AACT,iBAAO,MAAM,CAAC,KAAD,CAAb;AACD;;AAED,YAAI,aAAa,CAAC,KAAd,IAAuB,aAAa,CAAC,gBAAzC,EAA2D;AACzD,iBAAO,MAAM,CAAC,aAAD,CAAb;AACD;;AAED,eAAO,OAAO,CAAC,aAAD,CAAd;AACD,OAVD;AAWD,KAZM,CAAP;AAaD;AAUD;;;;;;;;;AAOa,EAAA,WAAW,CAAC,WAAD,EAAyB;;AAC/C,YAAM,aAAa,GAAG,MAAM,KAAK,QAAL,EAA5B;AACA,MAAA,WAAW,CAAC,OAAZ,CAAoB,GAApB,CAAwB,YAAA,CAAA,SAAA,CAAgB,eAAhB,CAAgC,aAAxD,EAAuE,GAAG,aAAa,CAAC,SAAS,IAAI,aAAa,CAAC,WAAW,EAA9H;AACA,aAAO,OAAO,CAAC,OAAR,CAAgB,WAAhB,CAAP;AACD,K;AAAA;;AA9EuC;;AAA1C,OAAA,CAAA,oBAAA,GAAA,oBAAA","sourceRoot":"","sourcesContent":["\"use strict\";\n// Copyright (c) Microsoft Corporation. All rights reserved.\n// Licensed under the MIT License. See License.txt in the project root for license information.\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst ms_rest_js_1 = require(\"@azure/ms-rest-js\");\nconst ms_rest_azure_env_1 = require(\"@azure/ms-rest-azure-env\");\nconst adal_node_1 = require(\"adal-node\");\nclass TokenCredentialsBase {\n    constructor(clientId, domain, tokenAudience, environment = ms_rest_azure_env_1.Environment.AzureCloud, tokenCache = new adal_node_1.MemoryCache()) {\n        this.clientId = clientId;\n        this.domain = domain;\n        this.tokenAudience = tokenAudience;\n        this.environment = environment;\n        this.tokenCache = tokenCache;\n        if (!clientId || typeof clientId.valueOf() !== \"string\") {\n            throw new Error(\"clientId must be a non empty string.\");\n        }\n        if (!domain || typeof domain.valueOf() !== \"string\") {\n            throw new Error(\"domain must be a non empty string.\");\n        }\n        if (this.tokenAudience === \"graph\" && this.domain.toLowerCase() === \"common\") {\n            throw new Error(`${\"If the tokenAudience is specified as \\\"graph\\\" then \\\"domain\\\" cannot be defaulted to \\\"commmon\\\" tenant.\\\n        It must be the actual tenant (preferrably a string in a guid format).\"}`);\n        }\n        const authorityUrl = this.environment.activeDirectoryEndpointUrl + this.domain;\n        this.authContext = new adal_node_1.AuthenticationContext(authorityUrl, this.environment.validateAuthority, this.tokenCache);\n    }\n    getActiveDirectoryResourceId() {\n        let resource = this.environment.activeDirectoryResourceId;\n        if (this.tokenAudience) {\n            resource = this.tokenAudience;\n            if (this.tokenAudience.toLowerCase() === \"graph\") {\n                resource = this.environment.activeDirectoryGraphResourceId;\n            }\n            else if (this.tokenAudience.toLowerCase() === \"batch\") {\n                resource = this.environment.batchResourceId;\n            }\n        }\n        return resource;\n    }\n    getTokenFromCache(username) {\n        const self = this;\n        const resource = this.getActiveDirectoryResourceId();\n        return new Promise((resolve, reject) => {\n            self.authContext.acquireToken(resource, username, self.clientId, (error, tokenResponse) => {\n                if (error) {\n                    return reject(error);\n                }\n                if (tokenResponse.error || tokenResponse.errorDescription) {\n                    return reject(tokenResponse);\n                }\n                return resolve(tokenResponse);\n            });\n        });\n    }\n    /**\n     * Signs a request with the Authentication header.\n     *\n     * @param {webResource} The WebResource to be signed.\n     * @param {function(error)}  callback  The callback function.\n     * @return {undefined}\n     */\n    signRequest(webResource) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const tokenResponse = yield this.getToken();\n            webResource.headers.set(ms_rest_js_1.Constants.HeaderConstants.AUTHORIZATION, `${tokenResponse.tokenType} ${tokenResponse.accessToken}`);\n            return Promise.resolve(webResource);\n        });\n    }\n}\nexports.TokenCredentialsBase = TokenCredentialsBase;\n//# sourceMappingURL=tokenCredentialsBase.js.map"]},"metadata":{},"sourceType":"script"}