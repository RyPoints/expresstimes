{"ast":null,"code":"'use strict';\n/**\n Returns an object that treats MSSQL's inabilities to do certain queries.\n\n @class QueryInterface\n @static\n @private\n */\n\n/**\n  A wrapper that fixes MSSQL's inability to cleanly remove columns from existing tables if they have a default constraint.\n\n  @method removeColumn\n  @for    QueryInterface\n\n  @param  {String} tableName     The name of the table.\n  @param  {String} attributeName The name of the attribute that we want to remove.\n  @param  {Object} options\n  @param  {Boolean|Function} [options.logging] A function that logs the sql queries, or false for explicitly not logging these queries\n @private\n */\n\nconst removeColumn = function (tableName, attributeName, options) {\n  options = Object.assign({\n    raw: true\n  }, options || {});\n  const findConstraintSql = this.QueryGenerator.getDefaultConstraintQuery(tableName, attributeName);\n  return this.sequelize.query(findConstraintSql, options).spread(results => {\n    if (!results.length) {\n      // No default constraint found -- we can cleanly remove the column\n      return;\n    }\n\n    const dropConstraintSql = this.QueryGenerator.dropConstraintQuery(tableName, results[0].name);\n    return this.sequelize.query(dropConstraintSql, options);\n  }).then(() => {\n    const findForeignKeySql = this.QueryGenerator.getForeignKeyQuery(tableName, attributeName);\n    return this.sequelize.query(findForeignKeySql, options);\n  }).spread(results => {\n    if (!results.length) {\n      // No foreign key constraints found, so we can remove the column\n      return;\n    }\n\n    const dropForeignKeySql = this.QueryGenerator.dropForeignKeyQuery(tableName, results[0].constraint_name);\n    return this.sequelize.query(dropForeignKeySql, options);\n  }).then(() => {\n    //Check if the current column is a primaryKey\n    const primaryKeyConstraintSql = this.QueryGenerator.getPrimaryKeyConstraintQuery(tableName, attributeName);\n    return this.sequelize.query(primaryKeyConstraintSql, options);\n  }).spread(result => {\n    if (!result.length) {\n      return;\n    }\n\n    const dropConstraintSql = this.QueryGenerator.dropConstraintQuery(tableName, result[0].constraintName);\n    return this.sequelize.query(dropConstraintSql, options);\n  }).then(() => {\n    const removeSql = this.QueryGenerator.removeColumnQuery(tableName, attributeName);\n    return this.sequelize.query(removeSql, options);\n  });\n};\n\nmodule.exports = {\n  removeColumn\n};","map":{"version":3,"sources":["/Users/ryandavis/Development/reactapp5/expresstimes/node_modules/sequelize/lib/dialects/mssql/query-interface.js"],"names":["removeColumn","tableName","attributeName","options","Object","assign","raw","findConstraintSql","QueryGenerator","getDefaultConstraintQuery","sequelize","query","spread","results","length","dropConstraintSql","dropConstraintQuery","name","then","findForeignKeySql","getForeignKeyQuery","dropForeignKeySql","dropForeignKeyQuery","constraint_name","primaryKeyConstraintSql","getPrimaryKeyConstraintQuery","result","constraintName","removeSql","removeColumnQuery","module","exports"],"mappings":"AAAA;AAEA;;;;;;;;AAQA;;;;;;;;;;;;;AAYA,MAAMA,YAAY,GAAG,UAASC,SAAT,EAAoBC,aAApB,EAAmCC,OAAnC,EAA4C;AAC/DA,EAAAA,OAAO,GAAGC,MAAM,CAACC,MAAP,CAAc;AAAEC,IAAAA,GAAG,EAAE;AAAP,GAAd,EAA6BH,OAAO,IAAI,EAAxC,CAAV;AAEA,QAAMI,iBAAiB,GAAG,KAAKC,cAAL,CAAoBC,yBAApB,CAA8CR,SAA9C,EAAyDC,aAAzD,CAA1B;AACA,SAAO,KAAKQ,SAAL,CAAeC,KAAf,CAAqBJ,iBAArB,EAAwCJ,OAAxC,EACJS,MADI,CACGC,OAAO,IAAI;AACjB,QAAI,CAACA,OAAO,CAACC,MAAb,EAAqB;AACnB;AACA;AACD;;AACD,UAAMC,iBAAiB,GAAG,KAAKP,cAAL,CAAoBQ,mBAApB,CAAwCf,SAAxC,EAAmDY,OAAO,CAAC,CAAD,CAAP,CAAWI,IAA9D,CAA1B;AACA,WAAO,KAAKP,SAAL,CAAeC,KAAf,CAAqBI,iBAArB,EAAwCZ,OAAxC,CAAP;AACD,GARI,EASJe,IATI,CASC,MAAM;AACV,UAAMC,iBAAiB,GAAG,KAAKX,cAAL,CAAoBY,kBAApB,CAAuCnB,SAAvC,EAAkDC,aAAlD,CAA1B;AACA,WAAO,KAAKQ,SAAL,CAAeC,KAAf,CAAqBQ,iBAArB,EAAwChB,OAAxC,CAAP;AACD,GAZI,EAaJS,MAbI,CAaGC,OAAO,IAAI;AACjB,QAAI,CAACA,OAAO,CAACC,MAAb,EAAqB;AACnB;AACA;AACD;;AACD,UAAMO,iBAAiB,GAAG,KAAKb,cAAL,CAAoBc,mBAApB,CAAwCrB,SAAxC,EAAmDY,OAAO,CAAC,CAAD,CAAP,CAAWU,eAA9D,CAA1B;AACA,WAAO,KAAKb,SAAL,CAAeC,KAAf,CAAqBU,iBAArB,EAAwClB,OAAxC,CAAP;AACD,GApBI,EAqBJe,IArBI,CAqBC,MAAM;AACV;AACA,UAAMM,uBAAuB,GAAG,KAAKhB,cAAL,CAAoBiB,4BAApB,CAAiDxB,SAAjD,EAA4DC,aAA5D,CAAhC;AACA,WAAO,KAAKQ,SAAL,CAAeC,KAAf,CAAqBa,uBAArB,EAA8CrB,OAA9C,CAAP;AACD,GAzBI,EA0BJS,MA1BI,CA0BGc,MAAM,IAAI;AAChB,QAAI,CAACA,MAAM,CAACZ,MAAZ,EAAoB;AAClB;AACD;;AACD,UAAMC,iBAAiB,GAAG,KAAKP,cAAL,CAAoBQ,mBAApB,CAAwCf,SAAxC,EAAmDyB,MAAM,CAAC,CAAD,CAAN,CAAUC,cAA7D,CAA1B;AACA,WAAO,KAAKjB,SAAL,CAAeC,KAAf,CAAqBI,iBAArB,EAAwCZ,OAAxC,CAAP;AACD,GAhCI,EAiCJe,IAjCI,CAiCC,MAAM;AACV,UAAMU,SAAS,GAAG,KAAKpB,cAAL,CAAoBqB,iBAApB,CAAsC5B,SAAtC,EAAiDC,aAAjD,CAAlB;AACA,WAAO,KAAKQ,SAAL,CAAeC,KAAf,CAAqBiB,SAArB,EAAgCzB,OAAhC,CAAP;AACD,GApCI,CAAP;AAqCD,CAzCD;;AA2CA2B,MAAM,CAACC,OAAP,GAAiB;AACf/B,EAAAA;AADe,CAAjB","sourcesContent":["'use strict';\n\n/**\n Returns an object that treats MSSQL's inabilities to do certain queries.\n\n @class QueryInterface\n @static\n @private\n */\n\n/**\n  A wrapper that fixes MSSQL's inability to cleanly remove columns from existing tables if they have a default constraint.\n\n  @method removeColumn\n  @for    QueryInterface\n\n  @param  {String} tableName     The name of the table.\n  @param  {String} attributeName The name of the attribute that we want to remove.\n  @param  {Object} options\n  @param  {Boolean|Function} [options.logging] A function that logs the sql queries, or false for explicitly not logging these queries\n @private\n */\nconst removeColumn = function(tableName, attributeName, options) {\n  options = Object.assign({ raw: true }, options || {});\n\n  const findConstraintSql = this.QueryGenerator.getDefaultConstraintQuery(tableName, attributeName);\n  return this.sequelize.query(findConstraintSql, options)\n    .spread(results => {\n      if (!results.length) {\n        // No default constraint found -- we can cleanly remove the column\n        return;\n      }\n      const dropConstraintSql = this.QueryGenerator.dropConstraintQuery(tableName, results[0].name);\n      return this.sequelize.query(dropConstraintSql, options);\n    })\n    .then(() => {\n      const findForeignKeySql = this.QueryGenerator.getForeignKeyQuery(tableName, attributeName);\n      return this.sequelize.query(findForeignKeySql, options);\n    })\n    .spread(results => {\n      if (!results.length) {\n        // No foreign key constraints found, so we can remove the column\n        return;\n      }\n      const dropForeignKeySql = this.QueryGenerator.dropForeignKeyQuery(tableName, results[0].constraint_name);\n      return this.sequelize.query(dropForeignKeySql, options);\n    })\n    .then(() => {\n      //Check if the current column is a primaryKey\n      const primaryKeyConstraintSql = this.QueryGenerator.getPrimaryKeyConstraintQuery(tableName, attributeName);\n      return this.sequelize.query(primaryKeyConstraintSql, options);\n    })\n    .spread(result => {\n      if (!result.length) {\n        return;\n      }\n      const dropConstraintSql = this.QueryGenerator.dropConstraintQuery(tableName, result[0].constraintName);\n      return this.sequelize.query(dropConstraintSql, options);\n    })\n    .then(() => {\n      const removeSql = this.QueryGenerator.removeColumnQuery(tableName, attributeName);\n      return this.sequelize.query(removeSql, options);\n    });\n};\n\nmodule.exports = {\n  removeColumn\n};\n"]},"metadata":{},"sourceType":"script"}