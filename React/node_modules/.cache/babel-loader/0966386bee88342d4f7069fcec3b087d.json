{"ast":null,"code":"'use strict';\n/**\n Returns an object that treats MSSQL's inabilities to do certain queries.\n\n @class QueryInterface\n @static\n @private\n */\n\n/**\n  A wrapper that fixes MSSQL's inability to cleanly remove columns from existing tables if they have a default constraint.\n\n\n  @param  {QueryInterface} qi\n  @param  {string} tableName     The name of the table.\n  @param  {string} attributeName The name of the attribute that we want to remove.\n  @param  {Object} options\n  @param  {boolean|Function} [options.logging] A function that logs the sql queries, or false for explicitly not logging these queries\n\n  @private\n */\n\nconst removeColumn = function (qi, tableName, attributeName, options) {\n  options = Object.assign({\n    raw: true\n  }, options || {});\n  const findConstraintSql = qi.QueryGenerator.getDefaultConstraintQuery(tableName, attributeName);\n  return qi.sequelize.query(findConstraintSql, options).then(([results]) => {\n    if (!results.length) {\n      // No default constraint found -- we can cleanly remove the column\n      return;\n    }\n\n    const dropConstraintSql = qi.QueryGenerator.dropConstraintQuery(tableName, results[0].name);\n    return qi.sequelize.query(dropConstraintSql, options);\n  }).then(() => {\n    const findForeignKeySql = qi.QueryGenerator.getForeignKeyQuery(tableName, attributeName);\n    return qi.sequelize.query(findForeignKeySql, options);\n  }).then(([results]) => {\n    if (!results.length) {\n      // No foreign key constraints found, so we can remove the column\n      return;\n    }\n\n    const dropForeignKeySql = qi.QueryGenerator.dropForeignKeyQuery(tableName, results[0].constraint_name);\n    return qi.sequelize.query(dropForeignKeySql, options);\n  }).then(() => {\n    //Check if the current column is a primaryKey\n    const primaryKeyConstraintSql = qi.QueryGenerator.getPrimaryKeyConstraintQuery(tableName, attributeName);\n    return qi.sequelize.query(primaryKeyConstraintSql, options);\n  }).then(([result]) => {\n    if (!result.length) {\n      return;\n    }\n\n    const dropConstraintSql = qi.QueryGenerator.dropConstraintQuery(tableName, result[0].constraintName);\n    return qi.sequelize.query(dropConstraintSql, options);\n  }).then(() => {\n    const removeSql = qi.QueryGenerator.removeColumnQuery(tableName, attributeName);\n    return qi.sequelize.query(removeSql, options);\n  });\n};\n\nmodule.exports = {\n  removeColumn\n};","map":{"version":3,"sources":["/Users/ryandavis/Development/reactapp/expresstimes/node_modules/sequelize/lib/dialects/mssql/query-interface.js"],"names":["removeColumn","qi","tableName","attributeName","options","Object","assign","raw","findConstraintSql","QueryGenerator","getDefaultConstraintQuery","sequelize","query","then","results","length","dropConstraintSql","dropConstraintQuery","name","findForeignKeySql","getForeignKeyQuery","dropForeignKeySql","dropForeignKeyQuery","constraint_name","primaryKeyConstraintSql","getPrimaryKeyConstraintQuery","result","constraintName","removeSql","removeColumnQuery","module","exports"],"mappings":"AAAA;AAEA;;;;;;;;AAQA;;;;;;;;;;;;;AAYA,MAAMA,YAAY,GAAG,UAASC,EAAT,EAAaC,SAAb,EAAwBC,aAAxB,EAAuCC,OAAvC,EAAgD;AACnEA,EAAAA,OAAO,GAAGC,MAAM,CAACC,MAAP,CAAc;AAAEC,IAAAA,GAAG,EAAE;AAAP,GAAd,EAA6BH,OAAO,IAAI,EAAxC,CAAV;AAEA,QAAMI,iBAAiB,GAAGP,EAAE,CAACQ,cAAH,CAAkBC,yBAAlB,CAA4CR,SAA5C,EAAuDC,aAAvD,CAA1B;AACA,SAAOF,EAAE,CAACU,SAAH,CAAaC,KAAb,CAAmBJ,iBAAnB,EAAsCJ,OAAtC,EACJS,IADI,CACC,CAAC,CAACC,OAAD,CAAD,KAAe;AACnB,QAAI,CAACA,OAAO,CAACC,MAAb,EAAqB;AACnB;AACA;AACD;;AACD,UAAMC,iBAAiB,GAAGf,EAAE,CAACQ,cAAH,CAAkBQ,mBAAlB,CAAsCf,SAAtC,EAAiDY,OAAO,CAAC,CAAD,CAAP,CAAWI,IAA5D,CAA1B;AACA,WAAOjB,EAAE,CAACU,SAAH,CAAaC,KAAb,CAAmBI,iBAAnB,EAAsCZ,OAAtC,CAAP;AACD,GARI,EASJS,IATI,CASC,MAAM;AACV,UAAMM,iBAAiB,GAAGlB,EAAE,CAACQ,cAAH,CAAkBW,kBAAlB,CAAqClB,SAArC,EAAgDC,aAAhD,CAA1B;AACA,WAAOF,EAAE,CAACU,SAAH,CAAaC,KAAb,CAAmBO,iBAAnB,EAAsCf,OAAtC,CAAP;AACD,GAZI,EAaJS,IAbI,CAaC,CAAC,CAACC,OAAD,CAAD,KAAe;AACnB,QAAI,CAACA,OAAO,CAACC,MAAb,EAAqB;AACnB;AACA;AACD;;AACD,UAAMM,iBAAiB,GAAGpB,EAAE,CAACQ,cAAH,CAAkBa,mBAAlB,CAAsCpB,SAAtC,EAAiDY,OAAO,CAAC,CAAD,CAAP,CAAWS,eAA5D,CAA1B;AACA,WAAOtB,EAAE,CAACU,SAAH,CAAaC,KAAb,CAAmBS,iBAAnB,EAAsCjB,OAAtC,CAAP;AACD,GApBI,EAqBJS,IArBI,CAqBC,MAAM;AACV;AACA,UAAMW,uBAAuB,GAAGvB,EAAE,CAACQ,cAAH,CAAkBgB,4BAAlB,CAA+CvB,SAA/C,EAA0DC,aAA1D,CAAhC;AACA,WAAOF,EAAE,CAACU,SAAH,CAAaC,KAAb,CAAmBY,uBAAnB,EAA4CpB,OAA5C,CAAP;AACD,GAzBI,EA0BJS,IA1BI,CA0BC,CAAC,CAACa,MAAD,CAAD,KAAc;AAClB,QAAI,CAACA,MAAM,CAACX,MAAZ,EAAoB;AAClB;AACD;;AACD,UAAMC,iBAAiB,GAAGf,EAAE,CAACQ,cAAH,CAAkBQ,mBAAlB,CAAsCf,SAAtC,EAAiDwB,MAAM,CAAC,CAAD,CAAN,CAAUC,cAA3D,CAA1B;AACA,WAAO1B,EAAE,CAACU,SAAH,CAAaC,KAAb,CAAmBI,iBAAnB,EAAsCZ,OAAtC,CAAP;AACD,GAhCI,EAiCJS,IAjCI,CAiCC,MAAM;AACV,UAAMe,SAAS,GAAG3B,EAAE,CAACQ,cAAH,CAAkBoB,iBAAlB,CAAoC3B,SAApC,EAA+CC,aAA/C,CAAlB;AACA,WAAOF,EAAE,CAACU,SAAH,CAAaC,KAAb,CAAmBgB,SAAnB,EAA8BxB,OAA9B,CAAP;AACD,GApCI,CAAP;AAqCD,CAzCD;;AA2CA0B,MAAM,CAACC,OAAP,GAAiB;AACf/B,EAAAA;AADe,CAAjB","sourcesContent":["'use strict';\n\n/**\n Returns an object that treats MSSQL's inabilities to do certain queries.\n\n @class QueryInterface\n @static\n @private\n */\n\n/**\n  A wrapper that fixes MSSQL's inability to cleanly remove columns from existing tables if they have a default constraint.\n\n\n  @param  {QueryInterface} qi\n  @param  {string} tableName     The name of the table.\n  @param  {string} attributeName The name of the attribute that we want to remove.\n  @param  {Object} options\n  @param  {boolean|Function} [options.logging] A function that logs the sql queries, or false for explicitly not logging these queries\n\n  @private\n */\nconst removeColumn = function(qi, tableName, attributeName, options) {\n  options = Object.assign({ raw: true }, options || {});\n\n  const findConstraintSql = qi.QueryGenerator.getDefaultConstraintQuery(tableName, attributeName);\n  return qi.sequelize.query(findConstraintSql, options)\n    .then(([results]) => {\n      if (!results.length) {\n        // No default constraint found -- we can cleanly remove the column\n        return;\n      }\n      const dropConstraintSql = qi.QueryGenerator.dropConstraintQuery(tableName, results[0].name);\n      return qi.sequelize.query(dropConstraintSql, options);\n    })\n    .then(() => {\n      const findForeignKeySql = qi.QueryGenerator.getForeignKeyQuery(tableName, attributeName);\n      return qi.sequelize.query(findForeignKeySql, options);\n    })\n    .then(([results]) => {\n      if (!results.length) {\n        // No foreign key constraints found, so we can remove the column\n        return;\n      }\n      const dropForeignKeySql = qi.QueryGenerator.dropForeignKeyQuery(tableName, results[0].constraint_name);\n      return qi.sequelize.query(dropForeignKeySql, options);\n    })\n    .then(() => {\n      //Check if the current column is a primaryKey\n      const primaryKeyConstraintSql = qi.QueryGenerator.getPrimaryKeyConstraintQuery(tableName, attributeName);\n      return qi.sequelize.query(primaryKeyConstraintSql, options);\n    })\n    .then(([result]) => {\n      if (!result.length) {\n        return;\n      }\n      const dropConstraintSql = qi.QueryGenerator.dropConstraintQuery(tableName, result[0].constraintName);\n      return qi.sequelize.query(dropConstraintSql, options);\n    })\n    .then(() => {\n      const removeSql = qi.QueryGenerator.removeColumnQuery(tableName, attributeName);\n      return qi.sequelize.query(removeSql, options);\n    });\n};\n\nmodule.exports = {\n  removeColumn\n};\n"]},"metadata":{},"sourceType":"script"}