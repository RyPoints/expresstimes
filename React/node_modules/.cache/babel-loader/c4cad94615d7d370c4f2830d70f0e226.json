{"ast":null,"code":"/*\r\n * @copyright\r\n * Copyright © Microsoft Open Technologies, Inc.\r\n *\r\n * All Rights Reserved\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http: *www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * THIS CODE IS PROVIDED *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS\r\n * OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION\r\n * ANY IMPLIED WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A\r\n * PARTICULAR PURPOSE, MERCHANTABILITY OR NON-INFRINGEMENT.\r\n *\r\n * See the Apache License, Version 2.0 for the specific language\r\n * governing permissions and limitations under the License.\r\n */\n'use strict';\n\nvar request = require('request');\n\nvar uuid = require('uuid');\n\nvar Logger = require('./log').Logger;\n\nvar util = require('./util');\n\nvar WSTrustResponse = require('./wstrust-response');\n\nvar WSTrustVersion = require('./constants').WSTrustVersion;\n\nvar USERNAME_PLACEHOLDER = '{UsernamePlaceHolder}';\nvar PASSWORD_PLACEHOLDER = '{PasswordPlaceHolder}';\n/**\r\n * Creates a new instance of WSTrustRequest\r\n * @constructor\r\n * @private\r\n * @param {object} callContext Contains any context information that applies to the request.\r\n * @param {string}     wstrustEndpointUrl    An STS WS-Trust soap endpoint.\r\n * @param {string}     appliesTo             A URI that identifies a service for which the a token is to be obtained.\r\n */\n\nfunction WSTrustRequest(callContext, wstrustEndpointUrl, appliesTo, wstrustEndpointVersion) {\n  this._log = new Logger('WSTrustRequest', callContext._logContext);\n  this._callContext = callContext;\n  this._wstrustEndpointUrl = wstrustEndpointUrl;\n  this._appliesTo = appliesTo;\n  this._wstrustEndpointVersion = wstrustEndpointVersion;\n}\n/**\r\n* Given a Date object adds the minutes parameter and returns a new Date object.\r\n* @private\r\n* @static\r\n* @memberOf WSTrustRequest\r\n* @param {Date}     date      A Date object.\r\n* @param {Number}   minutes   The number of minutes to add to the date parameter.\r\n* @returns {Date}             Returns a Date object.\r\n*/\n\n\nfunction _datePlusMinutes(date, minutes) {\n  var minutesInMilliSeconds = minutes * 60 * 1000;\n  var epochTime = date.getTime() + minutesInMilliSeconds;\n  return new Date(epochTime);\n}\n/**\r\n * Builds the soap security header for the RST message.\r\n * @private\r\n * @param {string}   username  A username\r\n * @param {string}   password  The passowrd that corresponds to the username parameter.\r\n * @returns {string}           A string that contains the soap security header.\r\n */\n\n\nWSTrustRequest.prototype._buildSecurityHeader = function () {\n  var timeNow = new Date();\n\n  var expireTime = _datePlusMinutes(timeNow, 10);\n\n  var timeNowString = timeNow.toISOString();\n  var expireTimeString = expireTime.toISOString();\n  var securityHeaderXml = '<wsse:Security s:mustUnderstand=\\'1\\' xmlns:wsse=\\'http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd\\'>\\\r\n    <wsu:Timestamp wsu:Id=\\'_0\\'>\\\r\n      <wsu:Created>' + timeNowString + '</wsu:Created>\\\r\n      <wsu:Expires>' + expireTimeString + '</wsu:Expires>\\\r\n    </wsu:Timestamp>\\\r\n    <wsse:UsernameToken wsu:Id=\\'ADALUsernameToken\\'>\\\r\n      <wsse:Username>' + USERNAME_PLACEHOLDER + '</wsse:Username>\\\r\n      <wsse:Password>' + PASSWORD_PLACEHOLDER + '</wsse:Password>\\\r\n    </wsse:UsernameToken>\\\r\n    </wsse:Security>';\n  return securityHeaderXml;\n};\n/**\r\n * Replaces the placeholders in the RST template with the actual username and password values.\r\n * @private\r\n * @param {string}   RSTTemplate  An RST with placeholders for username and password.\r\n * @param {string}   username     A username\r\n * @param {string}   password     The passowrd that corresponds to the username parameter.\r\n * @returns {string}              A string containing a complete RST soap message.\r\n */\n\n\nWSTrustRequest.prototype._populateRSTUsernamePassword = function (RSTTemplate, username, password) {\n  var RST = RSTTemplate.replace(USERNAME_PLACEHOLDER, username).replace(PASSWORD_PLACEHOLDER, this._populatedEscapedPassword(password));\n  return RST;\n};\n/**\r\n * Escape xml characters in password. \r\n * @private\r\n * @param {string} password The password to be excaped with xml charaters. \r\n */\n\n\nWSTrustRequest.prototype._populatedEscapedPassword = function (password) {\n  var escapedPassword = password;\n  return escapedPassword.replace(/&/g, '&amp;').replace(/\"/g, '&quot;').replace(/'/g, '&apos;').replace(/</g, '&lt;').replace(/>/g, '&gt;');\n};\n/**\r\n * Builds a WS-Trust RequestSecurityToken (RST) message using username password authentication.\r\n * @private\r\n * @param {string}   username  A username\r\n * @param {string}   password  The passowrd that corresponds to the username parameter.\r\n * @returns {string}           A string containing a complete RST soap message.\r\n */\n\n\nWSTrustRequest.prototype._buildRST = function (username, password) {\n  var messageID = uuid.v4(); // Create a template RST with placeholders for the username and password so the\n  // the RST can be logged without the sensitive information.\n\n  var schemaLocation = 'http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd';\n  var soapAction = 'http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue';\n  var rstTrustNamespace = 'http://docs.oasis-open.org/ws-sx/ws-trust/200512';\n  var keyType = 'http://docs.oasis-open.org/ws-sx/ws-trust/200512/Bearer';\n  var requestType = 'http://docs.oasis-open.org/ws-sx/ws-trust/200512/Issue';\n\n  if (this._wstrustEndpointVersion === WSTrustVersion.WSTRUST2005) {\n    soapAction = 'http://schemas.xmlsoap.org/ws/2005/02/trust/RST/Issue';\n    rstTrustNamespace = 'http://schemas.xmlsoap.org/ws/2005/02/trust';\n    keyType = 'http://schemas.xmlsoap.org/ws/2005/05/identity/NoProofKey';\n    requestType = 'http://schemas.xmlsoap.org/ws/2005/02/trust/Issue';\n  }\n\n  var RSTTemplate = '<s:Envelope xmlns:s=\\'http://www.w3.org/2003/05/soap-envelope\\' xmlns:wsa=\\'http://www.w3.org/2005/08/addressing\\' xmlns:wsu=\\'' + schemaLocation + '\\'>\\\r\n      <s:Header>\\\r\n        <wsa:Action s:mustUnderstand=\\'1\\'>' + soapAction + '</wsa:Action>\\\r\n        <wsa:messageID>urn:uuid:' + messageID + '</wsa:messageID>\\\r\n        <wsa:ReplyTo>\\\r\n          <wsa:Address>http://www.w3.org/2005/08/addressing/anonymous</wsa:Address>\\\r\n        </wsa:ReplyTo>\\\r\n        <wsa:To s:mustUnderstand=\\'1\\'>' + this._wstrustEndpointUrl + '</wsa:To>\\\r\n        ' + this._buildSecurityHeader() + '\\\r\n      </s:Header>\\\r\n      <s:Body>\\\r\n        <wst:RequestSecurityToken xmlns:wst=\\'' + rstTrustNamespace + '\\'>\\\r\n          <wsp:AppliesTo xmlns:wsp=\\'http://schemas.xmlsoap.org/ws/2004/09/policy\\'>\\\r\n            <wsa:EndpointReference>\\\r\n              <wsa:Address>' + this._appliesTo + '</wsa:Address>\\\r\n            </wsa:EndpointReference>\\\r\n          </wsp:AppliesTo>\\\r\n          <wst:KeyType>' + keyType + '</wst:KeyType>\\\r\n          <wst:RequestType>' + requestType + '</wst:RequestType>\\\r\n        </wst:RequestSecurityToken>\\\r\n      </s:Body>\\\r\n    </s:Envelope>';\n\n  this._log.verbose('Created RST: \\n' + RSTTemplate, true);\n\n  var RST = this._populateRSTUsernamePassword(RSTTemplate, username, password);\n\n  return RST;\n};\n/**\r\n * Handles the processing of a RSTR\r\n * @private\r\n * @param  {string}   body\r\n * @param  {WSTrustRequest.AcquireTokenCallback} callback\r\n */\n\n\nWSTrustRequest.prototype._handleRSTR = function (body, callback) {\n  var err;\n  var wstrustResponse = new WSTrustResponse(this._callContext, body, this._wstrustEndpointVersion);\n\n  try {\n    wstrustResponse.parse();\n  } catch (error) {\n    err = error;\n  }\n\n  callback(err, wstrustResponse);\n};\n/**\r\n * Performs a WS-Trust RequestSecurityToken request to obtain a federated token in exchange for a username password.\r\n * @param {string}   username  A username\r\n * @param {string}   password  The passowrd that corresponds to the username parameter.\r\n * @param {WSTrustRequest.AcquireTokenCallback} callback   Called once the federated token has been retrieved or on error.\r\n*/\n\n\nWSTrustRequest.prototype.acquireToken = function (username, password, callback) {\n  if (this._wstrustEndpointVersion === WSTrustVersion.UNDEFINED) {\n    var err = this._log.createError('Unsupported wstrust endpoint version. Current support version is wstrust2005 or wstrust13.');\n\n    callback(err);\n    return;\n  }\n\n  var self = this;\n\n  var RST = this._buildRST(username, password);\n\n  var soapAction = this._wstrustEndpointVersion === WSTrustVersion.WSTRUST2005 ? 'http://schemas.xmlsoap.org/ws/2005/02/trust/RST/Issue' : 'http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue';\n  var options = util.createRequestOptions(this, {\n    headers: {\n      'Content-Type': 'application/soap+xml; charset=utf-8',\n      'SOAPAction': soapAction\n    },\n    body: RST\n  });\n\n  this._log.verbose('Sending RST to: ' + this._wstrustEndpointUrl, true);\n\n  request.post(this._wstrustEndpointUrl, options, util.createRequestHandler('WS-Trust RST', this._log, callback, function (response, body) {\n    self._handleRSTR(body, callback);\n  }));\n};\n/**\r\n* @callback AcquireTokenCallback\r\n* @memberOf WSTrustRequest\r\n* @param {Error} err   Contains an error object if acquireToken fails.\r\n* @param {WSTrustResponse} A successful response to the RST.\r\n*/\n\n\nmodule.exports = WSTrustRequest;","map":{"version":3,"sources":["/Users/ryandavis/Development/reactapp5/expresstimes/node_modules/adal-node/lib/wstrust-request.js"],"names":["request","require","uuid","Logger","util","WSTrustResponse","WSTrustVersion","USERNAME_PLACEHOLDER","PASSWORD_PLACEHOLDER","WSTrustRequest","callContext","wstrustEndpointUrl","appliesTo","wstrustEndpointVersion","_log","_logContext","_callContext","_wstrustEndpointUrl","_appliesTo","_wstrustEndpointVersion","_datePlusMinutes","date","minutes","minutesInMilliSeconds","epochTime","getTime","Date","prototype","_buildSecurityHeader","timeNow","expireTime","timeNowString","toISOString","expireTimeString","securityHeaderXml","_populateRSTUsernamePassword","RSTTemplate","username","password","RST","replace","_populatedEscapedPassword","escapedPassword","_buildRST","messageID","v4","schemaLocation","soapAction","rstTrustNamespace","keyType","requestType","WSTRUST2005","verbose","_handleRSTR","body","callback","err","wstrustResponse","parse","error","acquireToken","UNDEFINED","createError","self","options","createRequestOptions","headers","post","createRequestHandler","response","module","exports"],"mappings":"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","sourcesContent":["/*\r\n * @copyright\r\n * Copyright © Microsoft Open Technologies, Inc.\r\n *\r\n * All Rights Reserved\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http: *www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * THIS CODE IS PROVIDED *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS\r\n * OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION\r\n * ANY IMPLIED WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A\r\n * PARTICULAR PURPOSE, MERCHANTABILITY OR NON-INFRINGEMENT.\r\n *\r\n * See the Apache License, Version 2.0 for the specific language\r\n * governing permissions and limitations under the License.\r\n */\r\n'use strict';\r\n\r\nvar request = require('request');\r\nvar uuid = require('uuid');\r\n\r\nvar Logger = require('./log').Logger;\r\nvar util = require('./util');\r\nvar WSTrustResponse = require('./wstrust-response');\r\nvar WSTrustVersion = require('./constants').WSTrustVersion;\r\n\r\nvar USERNAME_PLACEHOLDER = '{UsernamePlaceHolder}';\r\nvar PASSWORD_PLACEHOLDER = '{PasswordPlaceHolder}';\r\n\r\n/**\r\n * Creates a new instance of WSTrustRequest\r\n * @constructor\r\n * @private\r\n * @param {object} callContext Contains any context information that applies to the request.\r\n * @param {string}     wstrustEndpointUrl    An STS WS-Trust soap endpoint.\r\n * @param {string}     appliesTo             A URI that identifies a service for which the a token is to be obtained.\r\n */\r\nfunction WSTrustRequest(callContext, wstrustEndpointUrl, appliesTo, wstrustEndpointVersion) {\r\n  this._log = new Logger('WSTrustRequest', callContext._logContext);\r\n  this._callContext = callContext;\r\n  this._wstrustEndpointUrl = wstrustEndpointUrl;\r\n  this._appliesTo = appliesTo;\r\n  this._wstrustEndpointVersion = wstrustEndpointVersion;\r\n}\r\n\r\n/**\r\n* Given a Date object adds the minutes parameter and returns a new Date object.\r\n* @private\r\n* @static\r\n* @memberOf WSTrustRequest\r\n* @param {Date}     date      A Date object.\r\n* @param {Number}   minutes   The number of minutes to add to the date parameter.\r\n* @returns {Date}             Returns a Date object.\r\n*/\r\nfunction _datePlusMinutes(date, minutes) {\r\n  var minutesInMilliSeconds = minutes * 60 * 1000;\r\n  var epochTime = date.getTime() + minutesInMilliSeconds;\r\n  return new Date(epochTime);\r\n}\r\n\r\n/**\r\n * Builds the soap security header for the RST message.\r\n * @private\r\n * @param {string}   username  A username\r\n * @param {string}   password  The passowrd that corresponds to the username parameter.\r\n * @returns {string}           A string that contains the soap security header.\r\n */\r\nWSTrustRequest.prototype._buildSecurityHeader = function() {\r\n  var timeNow = new Date();\r\n  var expireTime = _datePlusMinutes(timeNow, 10);\r\n  var timeNowString = timeNow.toISOString();\r\n  var expireTimeString = expireTime.toISOString();\r\n\r\n  var securityHeaderXml = \r\n    '<wsse:Security s:mustUnderstand=\\'1\\' xmlns:wsse=\\'http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-secext-1.0.xsd\\'>\\\r\n    <wsu:Timestamp wsu:Id=\\'_0\\'>\\\r\n      <wsu:Created>' + timeNowString + '</wsu:Created>\\\r\n      <wsu:Expires>' + expireTimeString + '</wsu:Expires>\\\r\n    </wsu:Timestamp>\\\r\n    <wsse:UsernameToken wsu:Id=\\'ADALUsernameToken\\'>\\\r\n      <wsse:Username>' + USERNAME_PLACEHOLDER + '</wsse:Username>\\\r\n      <wsse:Password>' + PASSWORD_PLACEHOLDER + '</wsse:Password>\\\r\n    </wsse:UsernameToken>\\\r\n    </wsse:Security>';\r\n\r\n  return securityHeaderXml;\r\n};\r\n\r\n/**\r\n * Replaces the placeholders in the RST template with the actual username and password values.\r\n * @private\r\n * @param {string}   RSTTemplate  An RST with placeholders for username and password.\r\n * @param {string}   username     A username\r\n * @param {string}   password     The passowrd that corresponds to the username parameter.\r\n * @returns {string}              A string containing a complete RST soap message.\r\n */\r\n\r\nWSTrustRequest.prototype._populateRSTUsernamePassword = function(RSTTemplate, username, password) {\r\n  var RST = RSTTemplate.replace(USERNAME_PLACEHOLDER, username).replace(PASSWORD_PLACEHOLDER, this._populatedEscapedPassword(password));\r\n  return RST;\r\n};\r\n\r\n/**\r\n * Escape xml characters in password. \r\n * @private\r\n * @param {string} password The password to be excaped with xml charaters. \r\n */\r\nWSTrustRequest.prototype._populatedEscapedPassword = function (password) { \r\n    var escapedPassword = password;\r\n    return escapedPassword.replace(/&/g, '&amp;')\r\n            .replace(/\"/g, '&quot;')\r\n            .replace(/'/g, '&apos;')\r\n            .replace(/</g, '&lt;')\r\n            .replace(/>/g, '&gt;');\r\n}\r\n\r\n/**\r\n * Builds a WS-Trust RequestSecurityToken (RST) message using username password authentication.\r\n * @private\r\n * @param {string}   username  A username\r\n * @param {string}   password  The passowrd that corresponds to the username parameter.\r\n * @returns {string}           A string containing a complete RST soap message.\r\n */\r\nWSTrustRequest.prototype._buildRST = function(username, password) {\r\n  var messageID = uuid.v4();\r\n\r\n  // Create a template RST with placeholders for the username and password so the\r\n  // the RST can be logged without the sensitive information.\r\n  var schemaLocation = 'http://docs.oasis-open.org/wss/2004/01/oasis-200401-wss-wssecurity-utility-1.0.xsd';\r\n  var soapAction = 'http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue';\r\n  var rstTrustNamespace = 'http://docs.oasis-open.org/ws-sx/ws-trust/200512';\r\n  var keyType = 'http://docs.oasis-open.org/ws-sx/ws-trust/200512/Bearer';\r\n  var requestType = 'http://docs.oasis-open.org/ws-sx/ws-trust/200512/Issue';\r\n\r\n  if (this._wstrustEndpointVersion === WSTrustVersion.WSTRUST2005) {\r\n    soapAction = 'http://schemas.xmlsoap.org/ws/2005/02/trust/RST/Issue';\r\n    rstTrustNamespace = 'http://schemas.xmlsoap.org/ws/2005/02/trust';\r\n    keyType = 'http://schemas.xmlsoap.org/ws/2005/05/identity/NoProofKey';\r\n    requestType = 'http://schemas.xmlsoap.org/ws/2005/02/trust/Issue';  \r\n  }\r\n\r\n  var RSTTemplate =\r\n    '<s:Envelope xmlns:s=\\'http://www.w3.org/2003/05/soap-envelope\\' xmlns:wsa=\\'http://www.w3.org/2005/08/addressing\\' xmlns:wsu=\\'' + schemaLocation + '\\'>\\\r\n      <s:Header>\\\r\n        <wsa:Action s:mustUnderstand=\\'1\\'>' + soapAction + '</wsa:Action>\\\r\n        <wsa:messageID>urn:uuid:' + messageID + '</wsa:messageID>\\\r\n        <wsa:ReplyTo>\\\r\n          <wsa:Address>http://www.w3.org/2005/08/addressing/anonymous</wsa:Address>\\\r\n        </wsa:ReplyTo>\\\r\n        <wsa:To s:mustUnderstand=\\'1\\'>' + this._wstrustEndpointUrl + '</wsa:To>\\\r\n        ' + this._buildSecurityHeader() + '\\\r\n      </s:Header>\\\r\n      <s:Body>\\\r\n        <wst:RequestSecurityToken xmlns:wst=\\'' + rstTrustNamespace + '\\'>\\\r\n          <wsp:AppliesTo xmlns:wsp=\\'http://schemas.xmlsoap.org/ws/2004/09/policy\\'>\\\r\n            <wsa:EndpointReference>\\\r\n              <wsa:Address>' + this._appliesTo + '</wsa:Address>\\\r\n            </wsa:EndpointReference>\\\r\n          </wsp:AppliesTo>\\\r\n          <wst:KeyType>' + keyType + '</wst:KeyType>\\\r\n          <wst:RequestType>' + requestType + '</wst:RequestType>\\\r\n        </wst:RequestSecurityToken>\\\r\n      </s:Body>\\\r\n    </s:Envelope>';\r\n\r\n  this._log.verbose('Created RST: \\n' + RSTTemplate, true);\r\n\r\n  var RST = this._populateRSTUsernamePassword(RSTTemplate, username, password);\r\n  return RST;\r\n};\r\n\r\n/**\r\n * Handles the processing of a RSTR\r\n * @private\r\n * @param  {string}   body\r\n * @param  {WSTrustRequest.AcquireTokenCallback} callback\r\n */\r\nWSTrustRequest.prototype._handleRSTR = function(body, callback) {\r\n  var err;\r\n\r\n  var wstrustResponse = new WSTrustResponse(this._callContext, body, this._wstrustEndpointVersion);\r\n  try {\r\n    wstrustResponse.parse();\r\n  } catch (error) {\r\n    err = error;\r\n  }\r\n\r\n  callback(err, wstrustResponse);\r\n};\r\n\r\n/**\r\n * Performs a WS-Trust RequestSecurityToken request to obtain a federated token in exchange for a username password.\r\n * @param {string}   username  A username\r\n * @param {string}   password  The passowrd that corresponds to the username parameter.\r\n * @param {WSTrustRequest.AcquireTokenCallback} callback   Called once the federated token has been retrieved or on error.\r\n*/\r\nWSTrustRequest.prototype.acquireToken = function(username, password, callback) {\r\n  if (this._wstrustEndpointVersion === WSTrustVersion.UNDEFINED) {\r\n    var err = this._log.createError('Unsupported wstrust endpoint version. Current support version is wstrust2005 or wstrust13.');\r\n    callback(err);\r\n    return; \r\n  }\r\n\r\n  var self = this;\r\n  var RST = this._buildRST(username, password);\r\n\r\n  var soapAction = this._wstrustEndpointVersion === WSTrustVersion.WSTRUST2005 ? 'http://schemas.xmlsoap.org/ws/2005/02/trust/RST/Issue' : 'http://docs.oasis-open.org/ws-sx/ws-trust/200512/RST/Issue';\r\n\r\n  var options = util.createRequestOptions(\r\n    this,\r\n    {\r\n      headers : {\r\n        'Content-Type' : 'application/soap+xml; charset=utf-8',\r\n        'SOAPAction' : soapAction\r\n      },\r\n      body : RST\r\n    }\r\n  );\r\n\r\n  this._log.verbose('Sending RST to: ' + this._wstrustEndpointUrl, true);\r\n\r\n  request.post(this._wstrustEndpointUrl, options, util.createRequestHandler('WS-Trust RST', this._log, callback,\r\n    function(response, body) {\r\n      self._handleRSTR(body, callback);\r\n    }\r\n  ));\r\n};\r\n\r\n/**\r\n* @callback AcquireTokenCallback\r\n* @memberOf WSTrustRequest\r\n* @param {Error} err   Contains an error object if acquireToken fails.\r\n* @param {WSTrustResponse} A successful response to the RST.\r\n*/\r\n\r\nmodule.exports = WSTrustRequest;\r\n"]},"metadata":{},"sourceType":"script"}