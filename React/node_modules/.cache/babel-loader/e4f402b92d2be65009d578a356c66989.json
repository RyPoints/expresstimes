{"ast":null,"code":"/*\r\n * @copyright\r\n * Copyright Â© Microsoft Open Technologies, Inc.\r\n *\r\n * All Rights Reserved\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http: *www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * THIS CODE IS PROVIDED *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS\r\n * OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION\r\n * ANY IMPLIED WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A\r\n * PARTICULAR PURPOSE, MERCHANTABILITY OR NON-INFRINGEMENT.\r\n *\r\n * See the Apache License, Version 2.0 for the specific language\r\n * governing permissions and limitations under the License.\r\n */\n'use strict';\n\nvar request = require('request');\n\nvar url = require('url');\n\nvar _ = require('underscore');\n\nvar AADConstants = require('./constants').AADConstants;\n\nvar Logger = require('./log').Logger;\n\nvar util = require('./util');\n/**\r\n* Constructs an Authority object with a specific authority URL.\r\n* @private\r\n* @constructor\r\n* @param {string}   authorityUrl        A URL that identifies a token authority.\r\n* @param {bool}     validateAuthority   Indicates whether the Authority url should be validated as an actual AAD\r\n*                                       authority.  The default is true.\r\n*/\n\n\nfunction Authority(authorityUrl, validateAuthority) {\n  this._log = null;\n  this._url = url.parse(authorityUrl);\n\n  this._validateAuthorityUrl();\n\n  this._validated = !validateAuthority;\n  this._host = null;\n  this._tenant = null;\n\n  this._parseAuthority();\n\n  this._authorizationEndpoint = null;\n  this._tokenEndpoint = null;\n  this._deviceCodeEndpoint = null;\n  this._isAdfsAuthority = this._tenant.toLowerCase() === \"adfs\";\n}\n/**\r\n * The URL of the authority\r\n * @instance\r\n * @type {string}\r\n * @memberOf Authority\r\n * @name url\r\n */\n\n\nObject.defineProperty(Authority.prototype, 'url', {\n  get: function () {\n    return url.format(this._url);\n  }\n});\n/**\r\n * The token endpoint that the authority uses as discovered by instance discovery.\r\n * @instance\r\n * @type {string}\r\n * @memberOf Authority\r\n * @name tokenEndpoint\r\n */\n\nObject.defineProperty(Authority.prototype, 'tokenEndpoint', {\n  get: function () {\n    return this._tokenEndpoint;\n  }\n});\nObject.defineProperty(Authority.prototype, 'deviceCodeEndpoint', {\n  get: function () {\n    return this._deviceCodeEndpoint;\n  }\n});\n/**\r\n * Checks the authority url to ensure that it meets basic requirements such as being over SSL.  If it does not then\r\n * this method will throw if any of the checks fail.\r\n * @private\r\n * @throws {Error} If the authority url fails to pass any validation checks.\r\n */\n\nAuthority.prototype._validateAuthorityUrl = function () {\n  if (this._url.protocol !== 'https:') {\n    throw new Error('The authority url must be an https endpoint.');\n  }\n\n  if (this._url.query) {\n    throw new Error('The authority url must not have a query string.');\n  }\n};\n/**\r\n * Parse the authority to get the tenant name.  The rest of the\r\n * URL is thrown away in favor of one of the endpoints from the validation doc.\r\n * @private\r\n */\n\n\nAuthority.prototype._parseAuthority = function () {\n  this._host = this._url.host;\n\n  var pathParts = this._url.pathname.split('/');\n\n  this._tenant = pathParts[1];\n\n  if (!this._tenant) {\n    throw new Error('Could not determine tenant.');\n  }\n};\n/**\r\n * Performs instance discovery based on a simple match against well known authorities.\r\n * @private\r\n * @return {bool}  Returns true if the authority is recognized.\r\n */\n\n\nAuthority.prototype._performStaticInstanceDiscovery = function () {\n  this._log.verbose('Performing static instance discovery');\n\n  var hostIndex = _.indexOf(AADConstants.WELL_KNOWN_AUTHORITY_HOSTS, this._url.hostname);\n\n  var found = hostIndex > -1;\n\n  if (found) {\n    this._log.verbose('Authority validated via static instance discovery.');\n  }\n\n  return found;\n};\n\nAuthority.prototype._createAuthorityUrl = function () {\n  return 'https://' + this._url.host + '/' + encodeURIComponent(this._tenant) + AADConstants.AUTHORIZE_ENDPOINT_PATH;\n};\n/**\r\n * Creates an instance discovery endpoint url for the specific authority that this object represents.\r\n * @private\r\n * @param  {string} authorityHost The host name of a well known authority.\r\n * @return {URL}    The constructed endpoint url.\r\n */\n\n\nAuthority.prototype._createInstanceDiscoveryEndpointFromTemplate = function (authorityHost) {\n  var discoveryEndpoint = AADConstants.INSTANCE_DISCOVERY_ENDPOINT_TEMPLATE;\n  discoveryEndpoint = discoveryEndpoint.replace('{authorize_host}', authorityHost);\n  discoveryEndpoint = discoveryEndpoint.replace('{authorize_endpoint}', encodeURIComponent(this._createAuthorityUrl()));\n  return url.parse(discoveryEndpoint);\n};\n/**\r\n * Performs instance discovery via a network call to well known authorities.\r\n * @private\r\n * @param {Authority.InstanceDiscoveryCallback}   callback    The callback function.  If succesful,\r\n *                                                            this function calls the callback with the\r\n *                                                            tenantDiscoveryEndpoint returned by the\r\n *                                                            server.\r\n */\n\n\nAuthority.prototype._performDynamicInstanceDiscovery = function (callback) {\n  try {\n    var self = this;\n\n    var discoveryEndpoint = this._createInstanceDiscoveryEndpointFromTemplate(AADConstants.WORLD_WIDE_AUTHORITY);\n\n    var getOptions = util.createRequestOptions(self);\n\n    this._log.verbose('Attempting instance discover');\n\n    this._log.verbose('Attempting instance discover at: ' + url.format(discoveryEndpoint), true);\n\n    request.get(discoveryEndpoint, getOptions, util.createRequestHandler('Instance Discovery', this._log, callback, function (response, body) {\n      var discoveryResponse = JSON.parse(body);\n\n      if (discoveryResponse['tenant_discovery_endpoint']) {\n        callback(null, discoveryResponse['tenant_discovery_endpoint']);\n      } else {\n        callback(self._log.createError('Failed to parse instance discovery response'));\n      }\n    }));\n  } catch (e) {\n    callback(e);\n  }\n};\n/**\r\n * @callback InstanceDiscoveryCallback\r\n * @private\r\n * @memberOf Authority\r\n * @param {Error} err If an error occurs during instance discovery then it will be returned here.\r\n * @param {string} tenantDiscoveryEndpoint If instance discovery is successful then this will contain the\r\n *                                         tenantDiscoveryEndpoint associated with the authority.\r\n */\n\n/**\r\n * Determines whether the authority is recognized as a trusted AAD authority.\r\n * @private\r\n * @param {Authority.InstanceDiscoveryCallback}   callback    The callback function.\r\n */\n\n\nAuthority.prototype._validateViaInstanceDiscovery = function (callback) {\n  if (this._performStaticInstanceDiscovery()) {\n    callback();\n  } else {\n    this._performDynamicInstanceDiscovery(callback);\n  }\n};\n/**\r\n * @callback GetOauthEndpointsCallback\r\n * @private\r\n * @memberOf Authority\r\n * @param {Error} error An error if one occurred.\r\n */\n\n/**\r\n * Given a tenant discovery endpoint this method will attempt to discover the token endpoint.  If the\r\n * tenant discovery endpoint is unreachable for some reason then it will fall back to a algorithmic generation of the\r\n * token endpoint url.\r\n * @private\r\n * @param {string}           tenantDiscoveryEndpoint   The url of the tenant discovery endpoint for this authority.\r\n * @param {Authority.GetOauthEndpointsCallback}  callback  The callback function.\r\n */\n\n\nAuthority.prototype._getOAuthEndpoints = function (tenantDiscoveryEndpoint, callback) {\n  if (this._tokenEndpoint && this._deviceCodeEndpoint) {\n    callback();\n    return;\n  } else {\n    // fallback to the well known token endpoint path.\n    if (!this._tokenEndpoint) {\n      this._tokenEndpoint = url.format('https://' + this._url.host + '/' + encodeURIComponent(this._tenant)) + AADConstants.TOKEN_ENDPOINT_PATH;\n    }\n\n    if (!this._deviceCodeEndpoint) {\n      this._deviceCodeEndpoint = url.format('https://' + this._url.host + '/' + encodeURIComponent(this._tenant)) + AADConstants.DEVICE_ENDPOINT_PATH;\n    }\n\n    callback();\n    return;\n  }\n};\n/**\r\n * @callback ValidateCallback\r\n * @memberOf Authority\r\n */\n\n/**\r\n * Perform validation on the authority represented by this object.  In addition to simple validation\r\n * the oauth token endpoint will be retrieved.\r\n * @param {Authority.ValidateCallback}   callback   The callback function.\r\n */\n\n\nAuthority.prototype.validate = function (callContext, callback) {\n  this._log = new Logger('Authority', callContext._logContext);\n  this._callContext = callContext;\n  var self = this;\n\n  if (!this._validated) {\n    this._log.verbose('Performing instance discovery');\n\n    this._log.verbose('Performing instance discovery: ' + url.format(this._url), true);\n\n    this._validateViaInstanceDiscovery(function (err, tenantDiscoveryEndpoint) {\n      if (err) {\n        callback(err);\n      } else {\n        self._validated = true;\n\n        self._getOAuthEndpoints(tenantDiscoveryEndpoint, callback);\n\n        return;\n      }\n    });\n  } else {\n    this._log.verbose('Instance discovery/validation has either already been completed or is turned off');\n\n    this._log.verbose('Instance discovery/validation has either already been completed or is turned off: ' + url.format(this._url), true);\n\n    this._getOAuthEndpoints(null, callback);\n\n    return;\n  }\n};\n\nmodule.exports.Authority = Authority;","map":{"version":3,"sources":["/Users/ryandavis/Development/reactapp5/expresstimes/node_modules/adal-node/lib/authority.js"],"names":["request","require","url","_","AADConstants","Logger","util","Authority","authorityUrl","validateAuthority","_log","_url","parse","_validateAuthorityUrl","_validated","_host","_tenant","_parseAuthority","_authorizationEndpoint","_tokenEndpoint","_deviceCodeEndpoint","_isAdfsAuthority","toLowerCase","Object","defineProperty","prototype","get","format","protocol","Error","query","host","pathParts","pathname","split","_performStaticInstanceDiscovery","verbose","hostIndex","indexOf","WELL_KNOWN_AUTHORITY_HOSTS","hostname","found","_createAuthorityUrl","encodeURIComponent","AUTHORIZE_ENDPOINT_PATH","_createInstanceDiscoveryEndpointFromTemplate","authorityHost","discoveryEndpoint","INSTANCE_DISCOVERY_ENDPOINT_TEMPLATE","replace","_performDynamicInstanceDiscovery","callback","self","WORLD_WIDE_AUTHORITY","getOptions","createRequestOptions","createRequestHandler","response","body","discoveryResponse","JSON","createError","e","_validateViaInstanceDiscovery","_getOAuthEndpoints","tenantDiscoveryEndpoint","TOKEN_ENDPOINT_PATH","DEVICE_ENDPOINT_PATH","validate","callContext","_logContext","_callContext","err","module","exports"],"mappings":"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","sourcesContent":["/*\r\n * @copyright\r\n * Copyright Â© Microsoft Open Technologies, Inc.\r\n *\r\n * All Rights Reserved\r\n *\r\n * Licensed under the Apache License, Version 2.0 (the \"License\");\r\n * you may not use this file except in compliance with the License.\r\n * You may obtain a copy of the License at\r\n *\r\n * http: *www.apache.org/licenses/LICENSE-2.0\r\n *\r\n * THIS CODE IS PROVIDED *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS\r\n * OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION\r\n * ANY IMPLIED WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A\r\n * PARTICULAR PURPOSE, MERCHANTABILITY OR NON-INFRINGEMENT.\r\n *\r\n * See the Apache License, Version 2.0 for the specific language\r\n * governing permissions and limitations under the License.\r\n */\r\n'use strict';\r\n\r\nvar request = require('request');\r\nvar url = require('url');\r\nvar _ = require('underscore');\r\n\r\nvar AADConstants = require('./constants').AADConstants;\r\nvar Logger = require('./log').Logger;\r\nvar util = require('./util');\r\n\r\n/**\r\n* Constructs an Authority object with a specific authority URL.\r\n* @private\r\n* @constructor\r\n* @param {string}   authorityUrl        A URL that identifies a token authority.\r\n* @param {bool}     validateAuthority   Indicates whether the Authority url should be validated as an actual AAD\r\n*                                       authority.  The default is true.\r\n*/\r\nfunction Authority(authorityUrl, validateAuthority) {\r\n  this._log = null;\r\n  this._url = url.parse(authorityUrl);\r\n  this._validateAuthorityUrl();\r\n\r\n  this._validated = !validateAuthority;\r\n  this._host = null;\r\n  this._tenant = null;\r\n  this._parseAuthority();\r\n\r\n  this._authorizationEndpoint = null;\r\n  this._tokenEndpoint = null;\r\n  this._deviceCodeEndpoint = null;\r\n  this._isAdfsAuthority = (this._tenant.toLowerCase() === \"adfs\");\r\n}\r\n\r\n/**\r\n * The URL of the authority\r\n * @instance\r\n * @type {string}\r\n * @memberOf Authority\r\n * @name url\r\n */\r\nObject.defineProperty(Authority.prototype, 'url', {\r\n  get: function() {\r\n    return url.format(this._url);\r\n  }\r\n});\r\n\r\n/**\r\n * The token endpoint that the authority uses as discovered by instance discovery.\r\n * @instance\r\n * @type {string}\r\n * @memberOf Authority\r\n * @name tokenEndpoint\r\n */\r\nObject.defineProperty(Authority.prototype, 'tokenEndpoint', {\r\n  get: function() {\r\n    return this._tokenEndpoint;\r\n  }\r\n});\r\n\r\nObject.defineProperty(Authority.prototype, 'deviceCodeEndpoint', {\r\n    get: function() {\r\n        return this._deviceCodeEndpoint;\r\n    }\r\n});\r\n\r\n/**\r\n * Checks the authority url to ensure that it meets basic requirements such as being over SSL.  If it does not then\r\n * this method will throw if any of the checks fail.\r\n * @private\r\n * @throws {Error} If the authority url fails to pass any validation checks.\r\n */\r\nAuthority.prototype._validateAuthorityUrl = function() {\r\n  if (this._url.protocol !== 'https:') {\r\n    throw new Error('The authority url must be an https endpoint.');\r\n  }\r\n\r\n  if (this._url.query) {\r\n    throw new Error('The authority url must not have a query string.');\r\n  }\r\n};\r\n\r\n/**\r\n * Parse the authority to get the tenant name.  The rest of the\r\n * URL is thrown away in favor of one of the endpoints from the validation doc.\r\n * @private\r\n */\r\nAuthority.prototype._parseAuthority = function() {\r\n  this._host = this._url.host;\r\n\r\n  var pathParts = this._url.pathname.split('/');\r\n  this._tenant = pathParts[1];\r\n\r\n  if (!this._tenant) {\r\n    throw new Error('Could not determine tenant.');\r\n  }\r\n};\r\n\r\n/**\r\n * Performs instance discovery based on a simple match against well known authorities.\r\n * @private\r\n * @return {bool}  Returns true if the authority is recognized.\r\n */\r\nAuthority.prototype._performStaticInstanceDiscovery = function() {\r\n  this._log.verbose('Performing static instance discovery');\r\n\r\n  var hostIndex = _.indexOf(AADConstants.WELL_KNOWN_AUTHORITY_HOSTS, this._url.hostname);\r\n  var found = hostIndex > -1;\r\n\r\n  if (found) {\r\n    this._log.verbose('Authority validated via static instance discovery.');\r\n  }\r\n\r\n  return found;\r\n};\r\n\r\nAuthority.prototype._createAuthorityUrl = function() {\r\n  return 'https://' + this._url.host + '/' + encodeURIComponent(this._tenant) + AADConstants.AUTHORIZE_ENDPOINT_PATH;\r\n};\r\n\r\n/**\r\n * Creates an instance discovery endpoint url for the specific authority that this object represents.\r\n * @private\r\n * @param  {string} authorityHost The host name of a well known authority.\r\n * @return {URL}    The constructed endpoint url.\r\n */\r\nAuthority.prototype._createInstanceDiscoveryEndpointFromTemplate = function(authorityHost) {\r\n  var discoveryEndpoint = AADConstants.INSTANCE_DISCOVERY_ENDPOINT_TEMPLATE;\r\n  discoveryEndpoint = discoveryEndpoint.replace('{authorize_host}', authorityHost);\r\n  discoveryEndpoint = discoveryEndpoint.replace('{authorize_endpoint}', encodeURIComponent(this._createAuthorityUrl()));\r\n  return url.parse(discoveryEndpoint);\r\n};\r\n\r\n/**\r\n * Performs instance discovery via a network call to well known authorities.\r\n * @private\r\n * @param {Authority.InstanceDiscoveryCallback}   callback    The callback function.  If succesful,\r\n *                                                            this function calls the callback with the\r\n *                                                            tenantDiscoveryEndpoint returned by the\r\n *                                                            server.\r\n */\r\nAuthority.prototype._performDynamicInstanceDiscovery = function(callback) {\r\n  try {\r\n    var self = this;\r\n    var discoveryEndpoint = this._createInstanceDiscoveryEndpointFromTemplate(AADConstants.WORLD_WIDE_AUTHORITY);\r\n\r\n    var getOptions = util.createRequestOptions(self);\r\n\r\n    this._log.verbose('Attempting instance discover');\r\n    this._log.verbose('Attempting instance discover at: ' + url.format(discoveryEndpoint), true);\r\n    request.get(discoveryEndpoint, getOptions, util.createRequestHandler('Instance Discovery', this._log, callback,\r\n      function(response, body) {\r\n        var discoveryResponse = JSON.parse(body);\r\n\r\n        if (discoveryResponse['tenant_discovery_endpoint']) {\r\n          callback(null, discoveryResponse['tenant_discovery_endpoint']);\r\n        } else {\r\n          callback(self._log.createError('Failed to parse instance discovery response'));\r\n        }\r\n      })\r\n    );\r\n  } catch(e) {\r\n    callback(e);\r\n  }\r\n};\r\n\r\n/**\r\n * @callback InstanceDiscoveryCallback\r\n * @private\r\n * @memberOf Authority\r\n * @param {Error} err If an error occurs during instance discovery then it will be returned here.\r\n * @param {string} tenantDiscoveryEndpoint If instance discovery is successful then this will contain the\r\n *                                         tenantDiscoveryEndpoint associated with the authority.\r\n */\r\n\r\n/**\r\n * Determines whether the authority is recognized as a trusted AAD authority.\r\n * @private\r\n * @param {Authority.InstanceDiscoveryCallback}   callback    The callback function.\r\n */\r\nAuthority.prototype._validateViaInstanceDiscovery = function(callback) {\r\n  if (this._performStaticInstanceDiscovery()) {\r\n    callback();\r\n  } else {\r\n    this._performDynamicInstanceDiscovery(callback);\r\n  }\r\n};\r\n\r\n/**\r\n * @callback GetOauthEndpointsCallback\r\n * @private\r\n * @memberOf Authority\r\n * @param {Error} error An error if one occurred.\r\n */\r\n\r\n/**\r\n * Given a tenant discovery endpoint this method will attempt to discover the token endpoint.  If the\r\n * tenant discovery endpoint is unreachable for some reason then it will fall back to a algorithmic generation of the\r\n * token endpoint url.\r\n * @private\r\n * @param {string}           tenantDiscoveryEndpoint   The url of the tenant discovery endpoint for this authority.\r\n * @param {Authority.GetOauthEndpointsCallback}  callback  The callback function.\r\n */\r\nAuthority.prototype._getOAuthEndpoints = function(tenantDiscoveryEndpoint, callback) {\r\n  if (this._tokenEndpoint && this._deviceCodeEndpoint) {\r\n    callback();\r\n    return;\r\n  } else {\r\n    // fallback to the well known token endpoint path.\r\n    if (!this._tokenEndpoint){\r\n       this._tokenEndpoint = url.format('https://' + this._url.host + '/' + encodeURIComponent(this._tenant)) + AADConstants.TOKEN_ENDPOINT_PATH;\r\n    }\r\n\r\n    if (!this._deviceCodeEndpoint){\r\n       this._deviceCodeEndpoint = url.format('https://' + this._url.host + '/' + encodeURIComponent(this._tenant)) + AADConstants.DEVICE_ENDPOINT_PATH;\r\n    }\r\n\r\n    callback();\r\n    return;\r\n  }\r\n};\r\n\r\n/**\r\n * @callback ValidateCallback\r\n * @memberOf Authority\r\n */\r\n\r\n/**\r\n * Perform validation on the authority represented by this object.  In addition to simple validation\r\n * the oauth token endpoint will be retrieved.\r\n * @param {Authority.ValidateCallback}   callback   The callback function.\r\n */\r\nAuthority.prototype.validate = function(callContext, callback) {\r\n  this._log = new Logger('Authority', callContext._logContext);\r\n  this._callContext = callContext;\r\n  var self = this;\r\n\r\n  if (!this._validated) {\r\n    this._log.verbose('Performing instance discovery');\r\n    this._log.verbose('Performing instance discovery: ' + url.format(this._url), true);\r\n    this._validateViaInstanceDiscovery(function(err, tenantDiscoveryEndpoint) {\r\n      if (err)\r\n      {\r\n        callback(err);\r\n      } else {\r\n        self._validated = true;\r\n        self._getOAuthEndpoints(tenantDiscoveryEndpoint, callback);\r\n        return;\r\n      }\r\n    });\r\n  } else {\r\n    this._log.verbose('Instance discovery/validation has either already been completed or is turned off');\r\n    this._log.verbose('Instance discovery/validation has either already been completed or is turned off: ' + url.format(this._url), true);\r\n    this._getOAuthEndpoints(null, callback);\r\n    return;\r\n  }\r\n};\r\n\r\nmodule.exports.Authority = Authority;\r\n"]},"metadata":{},"sourceType":"script"}