{"ast":null,"code":"'use strict';\n\nconst AbstractConnectionManager = require('../abstract/connection-manager');\n\nconst ResourceLock = require('./resource-lock');\n\nconst Promise = require('../../promise');\n\nconst _require = require('../../utils/logger'),\n      logger = _require.logger;\n\nconst sequelizeErrors = require('../../errors');\n\nconst DataTypes = require('../../data-types').mssql;\n\nconst parserStore = require('../parserStore')('mssql');\n\nconst debug = logger.debugContext('connection:mssql');\nconst debugTedious = logger.debugContext('connection:mssql:tedious');\n\nclass ConnectionManager extends AbstractConnectionManager {\n  constructor(dialect, sequelize) {\n    sequelize.config.port = sequelize.config.port || 1433;\n    super(dialect, sequelize);\n    this.lib = this._loadDialectModule('tedious');\n    this.refreshTypeParser(DataTypes);\n  }\n\n  _refreshTypeParser(dataType) {\n    parserStore.refresh(dataType);\n  }\n\n  _clearTypeParser() {\n    parserStore.clear();\n  }\n\n  connect(config) {\n    const connectionConfig = {\n      server: config.host,\n      authentication: {\n        type: 'default',\n        options: {\n          userName: config.username || undefined,\n          password: config.password || undefined\n        }\n      },\n      options: {\n        port: parseInt(config.port, 10),\n        database: config.database,\n        encrypt: false\n      }\n    };\n\n    if (config.dialectOptions) {\n      // only set port if no instance name was provided\n      if (config.dialectOptions.options && config.dialectOptions.options.instanceName) {\n        delete connectionConfig.options.port;\n      }\n\n      if (config.dialectOptions.authentication) {\n        Object.assign(connectionConfig.authentication, config.dialectOptions.authentication);\n      }\n\n      Object.assign(connectionConfig.options, config.dialectOptions.options);\n    }\n\n    return new Promise((resolve, reject) => {\n      const connection = new this.lib.Connection(connectionConfig);\n      connection.lib = this.lib;\n      const resourceLock = new ResourceLock(connection);\n\n      const connectHandler = error => {\n        connection.removeListener('end', endHandler);\n        connection.removeListener('error', errorHandler);\n        if (error) return reject(error);\n        debug('connection acquired');\n        resolve(resourceLock);\n      };\n\n      const endHandler = () => {\n        connection.removeListener('connect', connectHandler);\n        connection.removeListener('error', errorHandler);\n        reject(new Error('Connection was closed by remote server'));\n      };\n\n      const errorHandler = error => {\n        connection.removeListener('connect', connectHandler);\n        connection.removeListener('end', endHandler);\n        reject(error);\n      };\n\n      connection.once('error', errorHandler);\n      connection.once('end', endHandler);\n      connection.once('connect', connectHandler);\n      /*\n       * Permanently attach this event before connection is even acquired\n       * tedious sometime emits error even after connect(with error).\n       *\n       * If we dont attach this even that unexpected error event will crash node process\n       *\n       * E.g. connectTimeout is set higher than requestTimeout\n       */\n\n      connection.on('error', error => {\n        switch (error.code) {\n          case 'ESOCKET':\n          case 'ECONNRESET':\n            this.pool.destroy(resourceLock);\n        }\n      });\n\n      if (config.dialectOptions && config.dialectOptions.debug) {\n        connection.on('debug', debugTedious.log.bind(debugTedious));\n      }\n    }).catch(error => {\n      if (!error.code) {\n        throw new sequelizeErrors.ConnectionError(error);\n      }\n\n      switch (error.code) {\n        case 'ESOCKET':\n          if (error.message.includes('connect EHOSTUNREACH')) {\n            throw new sequelizeErrors.HostNotReachableError(error);\n          }\n\n          if (error.message.includes('connect ENETUNREACH')) {\n            throw new sequelizeErrors.HostNotReachableError(error);\n          }\n\n          if (error.message.includes('connect EADDRNOTAVAIL')) {\n            throw new sequelizeErrors.HostNotReachableError(error);\n          }\n\n          if (error.message.includes('getaddrinfo ENOTFOUND')) {\n            throw new sequelizeErrors.HostNotFoundError(error);\n          }\n\n          if (error.message.includes('connect ECONNREFUSED')) {\n            throw new sequelizeErrors.ConnectionRefusedError(error);\n          }\n\n          throw new sequelizeErrors.ConnectionError(error);\n\n        case 'ER_ACCESS_DENIED_ERROR':\n        case 'ELOGIN':\n          throw new sequelizeErrors.AccessDeniedError(error);\n\n        case 'EINVAL':\n          throw new sequelizeErrors.InvalidConnectionError(error);\n\n        default:\n          throw new sequelizeErrors.ConnectionError(error);\n      }\n    });\n  }\n\n  disconnect(connectionLock) {\n    /**\n     * Abstract connection may try to disconnect raw connection used for fetching version\n     */\n    const connection = connectionLock.unwrap ? connectionLock.unwrap() : connectionLock; // Don't disconnect a connection that is already disconnected\n\n    if (connection.closed) {\n      return Promise.resolve();\n    }\n\n    return new Promise(resolve => {\n      connection.on('end', resolve);\n      connection.close();\n      debug('connection closed');\n    });\n  }\n\n  validate(connectionLock) {\n    /**\n     * Abstract connection may try to validate raw connection used for fetching version\n     */\n    const connection = connectionLock.unwrap ? connectionLock.unwrap() : connectionLock;\n    return connection && connection.loggedIn;\n  }\n\n}\n\nmodule.exports = ConnectionManager;\nmodule.exports.ConnectionManager = ConnectionManager;\nmodule.exports.default = ConnectionManager;","map":{"version":3,"sources":["/Users/ryandavis/Development/reactapp/expresstimes/node_modules/sequelize/lib/dialects/mssql/connection-manager.js"],"names":["AbstractConnectionManager","require","ResourceLock","Promise","logger","sequelizeErrors","DataTypes","mssql","parserStore","debug","debugContext","debugTedious","ConnectionManager","constructor","dialect","sequelize","config","port","lib","_loadDialectModule","refreshTypeParser","_refreshTypeParser","dataType","refresh","_clearTypeParser","clear","connect","connectionConfig","server","host","authentication","type","options","userName","username","undefined","password","parseInt","database","encrypt","dialectOptions","instanceName","Object","assign","resolve","reject","connection","Connection","resourceLock","connectHandler","error","removeListener","endHandler","errorHandler","Error","once","on","code","pool","destroy","log","bind","catch","ConnectionError","message","includes","HostNotReachableError","HostNotFoundError","ConnectionRefusedError","AccessDeniedError","InvalidConnectionError","disconnect","connectionLock","unwrap","closed","close","validate","loggedIn","module","exports","default"],"mappings":"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","sourcesContent":["'use strict';\n\nconst AbstractConnectionManager = require('../abstract/connection-manager');\nconst ResourceLock = require('./resource-lock');\nconst Promise = require('../../promise');\nconst { logger } = require('../../utils/logger');\nconst sequelizeErrors = require('../../errors');\nconst DataTypes = require('../../data-types').mssql;\nconst parserStore = require('../parserStore')('mssql');\nconst debug = logger.debugContext('connection:mssql');\nconst debugTedious = logger.debugContext('connection:mssql:tedious');\n\nclass ConnectionManager extends AbstractConnectionManager {\n  constructor(dialect, sequelize) {\n    sequelize.config.port = sequelize.config.port || 1433;\n    super(dialect, sequelize);\n    this.lib = this._loadDialectModule('tedious');\n    this.refreshTypeParser(DataTypes);\n  }\n\n  _refreshTypeParser(dataType) {\n    parserStore.refresh(dataType);\n  }\n\n  _clearTypeParser() {\n    parserStore.clear();\n  }\n\n  connect(config) {\n    const connectionConfig = {\n      server: config.host,\n      authentication: {\n        type: 'default',\n        options: {\n          userName: config.username || undefined,\n          password: config.password || undefined\n        }\n      },\n      options: {\n        port: parseInt(config.port, 10),\n        database: config.database,\n        encrypt: false\n      }\n    };\n\n    if (config.dialectOptions) {\n      // only set port if no instance name was provided\n      if (\n        config.dialectOptions.options &&\n        config.dialectOptions.options.instanceName\n      ) {\n        delete connectionConfig.options.port;\n      }\n\n      if (config.dialectOptions.authentication) {\n        Object.assign(connectionConfig.authentication, config.dialectOptions.authentication);\n      }\n\n      Object.assign(connectionConfig.options, config.dialectOptions.options);\n    }\n\n    return new Promise((resolve, reject) => {\n      const connection = new this.lib.Connection(connectionConfig);\n      connection.lib = this.lib;\n      const resourceLock = new ResourceLock(connection);\n\n      const connectHandler = error => {\n        connection.removeListener('end', endHandler);\n        connection.removeListener('error', errorHandler);\n\n        if (error) return reject(error);\n\n        debug('connection acquired');\n        resolve(resourceLock);\n      };\n\n      const endHandler = () => {\n        connection.removeListener('connect', connectHandler);\n        connection.removeListener('error', errorHandler);\n        reject(new Error('Connection was closed by remote server'));\n      };\n\n      const errorHandler = error => {\n        connection.removeListener('connect', connectHandler);\n        connection.removeListener('end', endHandler);\n        reject(error);\n      };\n\n      connection.once('error', errorHandler);\n      connection.once('end', endHandler);\n      connection.once('connect', connectHandler);\n\n      /*\n       * Permanently attach this event before connection is even acquired\n       * tedious sometime emits error even after connect(with error).\n       *\n       * If we dont attach this even that unexpected error event will crash node process\n       *\n       * E.g. connectTimeout is set higher than requestTimeout\n       */\n      connection.on('error', error => {\n        switch (error.code) {\n          case 'ESOCKET':\n          case 'ECONNRESET':\n            this.pool.destroy(resourceLock);\n        }\n      });\n\n      if (config.dialectOptions && config.dialectOptions.debug) {\n        connection.on('debug', debugTedious.log.bind(debugTedious));\n      }\n    }).catch(error => {\n      if (!error.code) {\n        throw new sequelizeErrors.ConnectionError(error);\n      }\n\n      switch (error.code) {\n        case 'ESOCKET':\n          if (error.message.includes('connect EHOSTUNREACH')) {\n            throw new sequelizeErrors.HostNotReachableError(error);\n          }\n          if (error.message.includes('connect ENETUNREACH')) {\n            throw new sequelizeErrors.HostNotReachableError(error);\n          }\n          if (error.message.includes('connect EADDRNOTAVAIL')) {\n            throw new sequelizeErrors.HostNotReachableError(error);\n          }\n          if (error.message.includes('getaddrinfo ENOTFOUND')) {\n            throw new sequelizeErrors.HostNotFoundError(error);\n          }\n          if (error.message.includes('connect ECONNREFUSED')) {\n            throw new sequelizeErrors.ConnectionRefusedError(error);\n          }\n          throw new sequelizeErrors.ConnectionError(error);\n        case 'ER_ACCESS_DENIED_ERROR':\n        case 'ELOGIN':\n          throw new sequelizeErrors.AccessDeniedError(error);\n        case 'EINVAL':\n          throw new sequelizeErrors.InvalidConnectionError(error);\n        default:\n          throw new sequelizeErrors.ConnectionError(error);\n      }\n    });\n  }\n\n  disconnect(connectionLock) {\n    /**\n     * Abstract connection may try to disconnect raw connection used for fetching version\n     */\n    const connection = connectionLock.unwrap\n      ? connectionLock.unwrap()\n      : connectionLock;\n\n    // Don't disconnect a connection that is already disconnected\n    if (connection.closed) {\n      return Promise.resolve();\n    }\n\n    return new Promise(resolve => {\n      connection.on('end', resolve);\n      connection.close();\n      debug('connection closed');\n    });\n  }\n\n  validate(connectionLock) {\n    /**\n     * Abstract connection may try to validate raw connection used for fetching version\n     */\n    const connection = connectionLock.unwrap\n      ? connectionLock.unwrap()\n      : connectionLock;\n\n    return connection && connection.loggedIn;\n  }\n}\n\nmodule.exports = ConnectionManager;\nmodule.exports.ConnectionManager = ConnectionManager;\nmodule.exports.default = ConnectionManager;\n"]},"metadata":{},"sourceType":"script"}